From 37cdb31464f7030875d0e7a9ec7c5e112a699764 Mon Sep 17 00:00:00 2001
From: CastagnaIT <gottardo.stefano.83@gmail.com>
Date: Sat, 26 Aug 2023 10:52:26 +0200
Subject: [PATCH] test2

---
 src/common/AdaptiveTree.cpp | 14 ++++++++++++++
 src/common/AdaptiveTree.h   |  5 +++++
 2 files changed, 19 insertions(+)

diff --git a/src/common/AdaptiveTree.cpp b/src/common/AdaptiveTree.cpp
index 04e6bdf21..72554387b 100644
--- a/src/common/AdaptiveTree.cpp
+++ b/src/common/AdaptiveTree.cpp
@@ -579,6 +579,20 @@ namespace adaptive
     }
   }
 
+  void AdaptiveTree::TreeUpdateThread::Stop()
+  {
+    // If an update is already in progress the wait until its finished
+    while (true)
+    {
+      std::lock_guard<std::mutex> updLck{m_updMutex};
+      if (m_waitQueue == 0)
+        break;
+      std::this_thread::sleep_for(std::chrono::milliseconds(10));
+    }
+    m_threadStop = true;
+    ResetStartTime();
+  }
+
   void AdaptiveTree::TreeUpdateThread::Pause()
   {
     // If an update is already in progress the wait until its finished
diff --git a/src/common/AdaptiveTree.h b/src/common/AdaptiveTree.h
index 45ef4044d..3d905ee55 100644
--- a/src/common/AdaptiveTree.h
+++ b/src/common/AdaptiveTree.h
@@ -525,6 +525,8 @@ class ATTR_DLL_LOCAL AdaptiveTree
   AdaptiveTree(const AdaptiveTree& left);
   virtual ~AdaptiveTree()
   {
+    m_updThread.Stop();
+
     for (auto period : periods_)
       delete period;
   }
@@ -639,6 +641,9 @@ class ATTR_DLL_LOCAL AdaptiveTree
     // \brief As "std::mutex" unlock, but resume the manifest updates (support std::lock_guard).
     void unlock() { Resume(); }
 
+    // \brief Stop performing new updates.
+    void Stop();
+
   private:
     void Worker();
     void Pause();
